<!doctype html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="theme-color" content="#1a5438">
    <link rel="apple-touch-icon" sizes="180x180" href="assets/images/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="assets/images/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/images/favicon/favicon-16x16.png">
    <link rel="shortcut icon" href="assets/images/favicon/favicon.ico">
    <link rel="manifest" href="/site.webmanifest">
    <title>Site Admin</title>
    <style>
        body {
            font-family: system-ui;
            padding: 1rem
        }

        label {
            display: block;
            margin-top: .5rem
        }
    </style>
</head>

<body>
    <h2>Site Admin</h2>

    <label>GitHub Token (store locally; keep secret)
        <input id="token" type="password" style="width:100%" />
    </label>

    <label>Owner
        <input id="owner" value="sophieallen0798" />
    </label>

    <label>Repo
        <input id="repo" value="vermontpaintworks" />
    </label>

    <label>File path (e.g. portfolio.html)
        <input id="path" value="index.html" style="width:100%" />
    </label>

    <div style="margin-top:.5rem">
        <button id="load">Load</button>
        <button id="save">Save</button>
        <span id="status" style="margin-left:1rem"></span>
    </div>

    <textarea id="editor" style="width:100%;height:60vh;margin-top:.5rem;font-family:monospace"></textarea>

    <script>
        const $ = id => document.getElementById(id);
        let currentSha = null;

        async function api(path, method = 'GET', body = null, token = null) {
            const headers = { Accept: 'application/vnd.github.v3+json' };
            if (token) headers.Authorization = 'token ' + token;
            const res = await fetch('https://api.github.com' + path, {
                method, headers, body: body ? JSON.stringify(body) : undefined
            });
            if (!res.ok) throw new Error(await res.text());
            return res.json();
        }

        $('load').onclick = async () => {
            $('status').textContent = 'Loading...';
            try {
                const owner = $('owner').value.trim();
                const repo = $('repo').value.trim();
                const path = encodeURIComponent($('path').value.trim());
                const token = $('token').value.trim() || null;
                const data = await api(`/repos/${owner}/${repo}/contents/${path}`, 'GET', null, token);
                const decoded = atob(data.content.replace(/\n/g, ''));
                $('editor').value = decoded;
                currentSha = data.sha;
                $('status').textContent = 'Loaded.';
            } catch (e) { $('status').textContent = 'Error: ' + e.message; }
        };

        $('save').onclick = async () => {
            $('status').textContent = 'Saving...';
            try {
                const owner = $('owner').value.trim();
                const repo = $('repo').value.trim();
                const path = encodeURIComponent($('path').value.trim());
                const token = $('token').value.trim();
                if (!token) throw new Error('Token required to save.');
                const content = btoa(unescape(encodeURIComponent($('editor').value)));
                const body = {
                    message: 'Update from site admin',
                    content,
                    sha: currentSha
                };
                const res = await api(`/repos/${owner}/${repo}/contents/${path}`, 'PUT', body, token);
                currentSha = res.content.sha;
                $('status').textContent = 'Saved. Commit: ' + res.commit.sha.slice(0, 7);
            } catch (e) { $('status').textContent = 'Error: ' + e.message; }
        };
    </script>
</body>

</html>